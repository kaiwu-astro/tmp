# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  test-GCC-5:
    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
    docker:
      - image: ubuntu:16.04
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - run:
          name: basic check
          command: cat /etc/os-release; pwd; ls -alh; ls ~ -alh
      - run: 
          name: install preqs
          command: apt update; apt install wget make gcc-5 g++-5 gfortran-5 -y
      - run:
          name: configure
          command: export CC=gcc-5; export CXX=g++-5; export FC=gfortran-5; export FCFLAGS="-g -O0 -fcheck=all -Wall"; export CFLAGS=$FCFLAGS; export CXXFLAGS=$FCFLAGS; ./configure --with-par=b1m --enable-simd=no --enable-mcmodel=large --disable-mpi --disable-gpu
      - run:
          name: make
          command: make clean; make -j
      - run: 
          name: generate test dir and ini file
          command: mkdir autotest; cp -p ./build/nbody6++.sse ./autotest/; cd autotest; wget https://github.com/kaiwu-astro/garage/raw/main/Nbody6ppGPU-inputfile/kai_10k/10k.test; wget https://github.com/kaiwu-astro/garage/raw/main/Nbody6ppGPU-inputfile/kai_10k/dat.10; pwd; ls -alh
      - run:
          name: run simulation
          command: cd autotest; export OMP_NUM_THREADS=32; ./nbody6++.sse < 10k.test
# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  test-with-GCC-5:
    jobs:
      - test-GCC-5